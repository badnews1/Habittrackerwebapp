/**
 * Утилиты для работы с единицами измерения
 * 
 * Этот файл содержит функции для склонения единиц, форматирования чисел
 * и получения сокращённых названий единиц измерения.
 */

/**
 * Склонение единиц измерения в зависимости от числа
 * 
 * @param value - Числовое значение
 * @param unit - Единица измерения в форме множественного числа
 * @returns Правильно склонённая единица измерения
 * 
 * @example
 * declineUnit(1, 'разы') // "раз"
 * declineUnit(2, 'разы') // "раза"
 * declineUnit(5, 'разы') // "раз"
 * declineUnit(1.5, 'литры') // "литра"
 */
export function declineUnit(value: number, unit: string): string {
  // Валюты и сокращения не склоняются
  if (unit === 'руб.' || unit === '$' || unit === '€') {
    return unit;
  }

  // Для дробных чисел всегда используем форму 2 (родительный падеж единственного числа)
  // 1.5 литра, 2.5 килограмма, 0.5 часа
  const isFractional = value % 1 !== 0;

  // Получаем последнюю цифру и последние две цифры
  const absValue = Math.abs(value);
  const lastDigit = Math.floor(absValue) % 10;
  const lastTwoDigits = Math.floor(absValue) % 100;

  // Определяем форму склонения (1, 2, или 5)
  let form: 1 | 2 | 5;
  if (isFractional) {
    form = 2; // Дробные числа всегда используют форму 2
  } else if (lastTwoDigits >= 11 && lastTwoDigits <= 19) {
    form = 5; // 11-19 всегда множественное число
  } else if (lastDigit === 1) {
    form = 1; // 1, 21, 31, ...
  } else if (lastDigit >= 2 && lastDigit <= 4) {
    form = 2; // 2-4, 22-24, ...
  } else {
    form = 5; // 0, 5-9, 10, 20, ...
  }

  // Словарь склонений: единица -> [форма1, форма2, форма5]
  const declensions: Record<string, [string, string, string]> = {
    'разы': ['раз', 'раза', 'раз'],
    'штуки': ['штука', 'штуки', 'штук'],
    'баллы': ['балл', 'балла', 'баллов'],
    'минуты': ['минута', 'минуты', 'минут'],
    'часы': ['час', 'часа', 'часов'],
    'шаги': ['шаг', 'шага', 'шагов'],
    'километры': ['километр', 'километра', 'километров'],
    'метры': ['метр', 'метра', 'метров'],
    'подходы': ['подход', 'подхода', 'подходов'],
    'калории': ['калория', 'калории', 'калорий'],
    'килограммы': ['килограмм', 'килограмма', 'килограммов'],
    'граммы': ['грамм', 'грамма', 'граммов'],
    'стаканы': ['стакан', 'стакана', 'стаканов'],
    'литры': ['литр', 'литра', 'литров'],
    'милилитры': ['милилитр', 'милилитра', 'милилитров'],
    'порции': ['порция', 'порции', 'порций'],
    'чашки': ['чашка', 'чашки', 'чашек'],
    'страницы': ['страница', 'страницы', 'страниц'],
    'слова': ['слово', 'слова', 'слов'],
    'главы': ['глава', 'главы', 'глав'],
    'задачи': ['задача', 'задачи', 'задач'],
  };

  const forms = declensions[unit];
  if (!forms) {
    return unit; // Если единицы нет в словаре, возвращаем как есть
  }

  if (form === 1) return forms[0];
  if (form === 2) return forms[1];
  return forms[2];
}

/**
 * Получение сокращенного названия единицы измерения для календарной сетки
 * 
 * @param unit - Полное название единицы измерения
 * @returns Сокращённое название
 * 
 * @example
 * getShortUnit('километры') // "км"
 * getShortUnit('литры') // "л"
 * getShortUnit('минуты') // "мин"
 */
export function getShortUnit(unit: string): string {
  const shortUnits: Record<string, string> = {
    'разы': 'раз',
    'штуки': 'шт',
    'баллы': 'б',
    'минуты': 'мин',
    'часы': 'ч',
    'шаги': 'шаг',
    'километры': 'км',
    'метры': 'м',
    'подходы': 'подх',
    'калории': 'ккал',
    'килограммы': 'кг',
    'граммы': 'г',
    'стаканы': 'стак',
    'литры': 'л',
    'милилитры': 'мл',
    'порции': 'порц',
    'чашки': 'чаш',
    'страницы': 'стр',
    'слова': 'сл',
    'главы': 'гл',
    'задачи': 'зад',
    'руб.': 'руб',
    '$': '$',
    '€': '€',
  };

  return shortUnits[unit] || unit;
}

/**
 * Форматирование больших чисел для компактного отображения в календаре
 * 
 * @param num - Число для форматирования
 * @returns Отформатированная строка
 * 
 * @example
 * formatNumber(999) // "999"
 * formatNumber(10000) // "10k"
 * formatNumber(15500) // "15.5k"
 * formatNumber(100000) // "100k"
 * formatNumber(1500000) // "1.5M"
 * 
 * Правила форматирования:
 * - 0-9999: как есть
 * - 10000-99999: с k и десятичной частью (например: 10k, 15.5k)
 * - 100000-999999: с k, округление (например: 101k, 100k)
 * - 1000000+: с M (например: 1M, 1.5M)
 */
export function formatNumber(num: number): string {
  if (num < 10000) {
    return num.toString();
  } else if (num < 100000) {
    const k = num / 1000;
    const rounded = parseFloat(k.toFixed(1));
    // Если после округления получилось целое число, показываем без .0
    return rounded % 1 === 0 ? `${Math.round(rounded)}k` : `${rounded}k`;
  } else if (num < 1000000) {
    const k = Math.round(num / 1000);
    // Если округление дало >= 1000k, показываем как M
    if (k >= 1000) {
      return '1M';
    }
    return `${k}k`;
  } else {
    const m = num / 1000000;
    const rounded = parseFloat(m.toFixed(1));
    return rounded % 1 === 0 ? `${Math.round(rounded)}M` : `${rounded}M`;
  }
}
